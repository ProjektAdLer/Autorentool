@using AuthoringTool.PresentationLogic.AuthoringToolWorkspace
@using AuthoringTool.PresentationLogic.LearningElement
@using AuthoringTool.PresentationLogic.LearningSpace
@using AuthoringTool.PresentationLogic.LearningWorld
@using AuthoringTool.Components
@using AuthoringTool.Components.ModalDialog
@using AuthoringTool.PresentationLogic.LearningElement.ActivationElement
@using AuthoringTool.PresentationLogic.LearningElement.InteractionElement
@using AuthoringTool.PresentationLogic.LearningElement.TestElement
@using AuthoringTool.PresentationLogic.LearningElement.TransferElement
@using AuthoringTool.PresentationLogic.ModalDialog
@using AuthoringTool.View.LearningSpace

<h2>World: @LearningWorldP.LearningWorldVm?.Name</h2>
@ChildContent
@if (LearningWorldP.ShowingLearningSpaceView)
{
    <LearningSpaceView>
        <button class="btn btn-primary" @onclick="CloseLearningSpaceView">Close Learning Space View</button>
    </LearningSpaceView>
}
else
{
    <h5>Workload: @LearningWorldP.LearningWorldVm?.Workload minutes</h5>
    <button class="btn btn-primary" @onclick="AddNewLearningSpace">Add Learning Space</button>
    <button class="btn btn-primary" @onclick="LoadLearningSpaceAsync">Load Learning Space</button>
    @if (LearningWorldP.CreateLearningSpaceDialogueOpen)
    {
        @ModalDialogFactory.GetCreateLearningSpaceFragment(OnCreateSpaceDialogClose);
    }
    <button class="btn btn-primary" @onclick="AddNewLearningElement">Add Learning Element</button>
    <button class="btn btn-primary" @onclick="LoadLearningElementAsync">Load Learning Element</button>
    @if (LearningWorldP.CreateLearningElementDialogOpen)
    {
        <!-- LearningWorld can't be null at this point - n.stich -->
        @ModalDialogFactory.GetCreateLearningElementFragment(LearningWorldP.DragAndDropLearningContent,
            LearningWorldP.LearningWorldVm!.LearningSpaces, LearningWorldP.LearningWorldVm.Name, OnCreateElementDialogClose);
    }
    <br>

    @if (LearningWorldP.LearningWorldVm?.SelectedLearningObject != null)
    {
        <label>
            Selected element:
            <text>
                @LearningWorldP.LearningWorldVm.SelectedLearningObject.Name
                , Description:
                @LearningWorldP.LearningWorldVm.SelectedLearningObject.Description
            </text>
        </label>
        <br>
        <button class="btn btn-primary" @onclick="EditLearningObject">Edit selected Learning Object</button>
        <button class="btn btn-primary" @onclick="DeleteSelectedLearningObject">Delete Learning Object</button>
        <button class="btn btn-primary" @onclick="SaveSelectedLearningObjectAsync">Save selected Learning Object</button>
        <button class="btn btn-primary" @onclick="ShowSelectedLearningSpaceView"
                hidden="@(!LearningWorldP.SelectedLearningObjectIsSpace)">Open selected Learning Space</button>
    }
    <svg style="width: 100%; height: 600px; border: 1px solid green"
         xmlns="http://www.w3.org/2000/svg"
         @onmousemove=@(e => MouseService.FireMove(this, e))
             @onmouseup=@(e => MouseService.FireUp(this, e))
             @onmouseleave=@(() => MouseService.FireOut(this, null))>
        @if (LearningWorldP.LearningWorldVm != null)
        {
            @foreach (var learningObject in LearningWorldP.LearningWorldVm.LearningObjects)
            {
                <Draggable LearningObject="learningObject" OnClicked="@LearningWorldP.SetSelectedLearningObject"
                           @bind-X="@learningObject.PositionX" @bind-Y="@learningObject.PositionY">
                    @{
                        string polygonColor, polygonPoints, rectStyle;

                        switch (learningObject)
                        {
                            case LearningElementViewModel learningElementViewModel:
                                rectStyle = "fill:lightblue";
                                switch (learningElementViewModel.Difficulty)
                                {
                                    case LearningElementDifficultyEnum.Easy:
                                        polygonPoints = "13 1 10 10 2 13 10 16 13 25 16 16 24 13 16 10";
                                        polygonColor = "green";
                                        break;
                                    case LearningElementDifficultyEnum.Medium:
                                        polygonPoints = "13 1 5 25 24 10 2 10 21 25";
                                        polygonColor = "yellow";
                                        break;
                                    case LearningElementDifficultyEnum.Hard:
                                        polygonPoints = "13 1 10 8 2 7 8 13 2 19 10 18 13 25 16 18 24 19 19 13 24 7 16 8 13 1";
                                        polygonColor = "red";
                                        break;
                                    case LearningElementDifficultyEnum.None:
                                        polygonPoints = "0";
                                        polygonColor = "lightblue";
                                        break;
                                    default:
                                        throw new ArgumentOutOfRangeException();
                                }
                                break;
                            case LearningSpaceViewModel:
                                rectStyle = "fill:lightgreen;stroke:black";
                                polygonPoints = "0";
                                polygonColor = "lightgreen";
                                break;
                            default:
                                throw new ArgumentOutOfRangeException(nameof(learningObject));
                        }
                    }
                    <rect height="50" width="100" style=@rectStyle></rect>
                    <polygon transform="translate(75,1)" fill=@polygonColor
                             points=@polygonPoints></polygon>
                    <text x="3" y="15">@learningObject.Name</text>

                </Draggable>
            }
        }
    </svg>
    @if (LearningWorldP.EditLearningSpaceDialogOpen && LearningWorldP.LearningWorldVm != null)
    {
        <!-- EditSpaceDialogInitialValues is set by presenter before setting EditLearningSpaceDialogOpen to true -->
        @ModalDialogFactory.GetEditLearningSpaceFragment(LearningWorldP.EditSpaceDialogInitialValues!, OnEditSpaceDialogClose)
    }

    @if (LearningWorldP.EditLearningElementDialogOpen && LearningWorldP.LearningWorldVm != null)
    {
        <!-- EditElementDialogInitialValues is set by presenter before setting EditLearningElementDialogOpen to true -->
        @ModalDialogFactory.GetEditLearningElementFragment(LearningWorldP.EditElementDialogInitialValues!, OnEditElementDialogClose)
    }

    @if (ErrorState != null)
    {
        <ModalDialog Title="Exception encountered" Text=@ErrorState.ToString()
                     OnClose="@(_ => { ErrorState = null; })" DialogType=@ModalDialogType.Ok/>
    }
}

@code {

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

#pragma warning disable CS8618 injected by framework - n.stich
    [Inject]
    public IMouseService MouseService { get; set; }
    
    [Inject]
    public ILearningWorldPresenter LearningWorldP { get; set; }
    
    [Inject]
    public ILearningWorldViewModalDialogFactory ModalDialogFactory { get; set; }
#pragma warning restore CS8618
    
    private ExceptionWrapper? ErrorState { get; set; }


    private void AddNewLearningSpace()
    {
        LearningWorldP.CreateLearningSpaceDialogueOpen = true;
    }

    private void AddNewLearningElement()
    {
        LearningWorldP.CreateLearningElementDialogOpen = true;
    }

    private void DeleteSelectedLearningObject()
    {
        LearningWorldP.DeleteSelectedLearningObject();
    }

    private async Task LoadLearningSpaceAsync()
    {
        try
        {
            await LearningWorldP.LoadLearningSpace();
        }
        catch (OperationCanceledException)
        {
    //nothing to do, show notification?
        }
        catch (Exception exception)
        {
            ErrorState = new ExceptionWrapper("Load learning space", exception);
        }
        finally
        {
    //we need to tell blazor explicitly to re-render our component after we added the loaded learning object
            StateHasChanged();
        }
    }

    private async Task LoadLearningElementAsync()
    {
        try
        {
            await LearningWorldP.LoadLearningElement();
        }
        catch (OperationCanceledException)
        {
    //nothing to do, show notification?
        }
        catch (Exception exception)
        {
            ErrorState = new ExceptionWrapper("Load learning element", exception);
        }
        finally
        {
    //we need to tell blazor explicitly to re-render our component after we added the loaded learning object
            StateHasChanged();
        }
    }

    private async Task SaveSelectedLearningObjectAsync()
    {
        try
        {
            await LearningWorldP.SaveSelectedLearningObjectAsync();
        }
        catch (OperationCanceledException)
        {
    //nothing to do, show notification?
        }
        catch (Exception exception)
        {
            ErrorState = new ExceptionWrapper("Save learning object", exception);
        }
        finally
        {
    //we need to tell blazor explicitly to re-render our component after we added the loaded learning object
            StateHasChanged();
        }
    }

    private void OnCreateSpaceDialogClose(ModalDialogOnCloseResult returnValueTuple)
    {
        LearningWorldP.OnCreateSpaceDialogClose(returnValueTuple);
        StateHasChanged();
    }

    private void OnCreateElementDialogClose(ModalDialogOnCloseResult returnValueTuple)
    {
        LearningWorldP.OnCreateElementDialogClose(returnValueTuple);
        StateHasChanged();
    }

    private void EditLearningObject()
    {
        LearningWorldP.OpenEditSelectedLearningObjectDialog();
    }

    private void OnEditSpaceDialogClose(ModalDialogOnCloseResult returnValueTuple)
    {
        LearningWorldP.OnEditSpaceDialogClose(returnValueTuple);
        StateHasChanged();
    }

    private void OnEditElementDialogClose(ModalDialogOnCloseResult returnValueTuple)
    {
        LearningWorldP.OnEditElementDialogClose(returnValueTuple);
        StateHasChanged();
    }

    public void TriggerStateHasChanged()
    {
        StateHasChanged();
    }

    private void ShowSelectedLearningSpaceView()
    {
        LearningWorldP.ShowSelectedLearningSpaceView();
    }

    private void CloseLearningSpaceView()
    {
        LearningWorldP.CloseLearningSpaceView();
    }

}