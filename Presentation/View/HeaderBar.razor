@using Size = MudBlazor.Size
@using Color = MudBlazor.Color
@using Presentation.PresentationLogic.Extensions
@using Presentation.PresentationLogic.LearningContent.AdaptivityContent
@using Presentation.PresentationLogic.LearningContent.AdaptivityContent.Action
@using Presentation.PresentationLogic.LearningElement
@using Presentation.PresentationLogic.LearningSpace
@using Presentation.PresentationLogic.LearningWorld
@using Presentation.PresentationLogic.Mediator
@using Presentation.PresentationLogic.SelectedViewModels
@using Shared.Exceptions
@using Presentation.PresentationLogic.API
@using Presentation.PresentationLogic.AuthoringToolWorkspace
@using ElectronWrapper
@using Microsoft.Extensions.Localization
@using System.ComponentModel
@using System.Diagnostics.CodeAnalysis
@using Presentation.PresentationLogic
@using Presentation.Components.Culture
@using Presentation.Components.Dialogues
@using Presentation.Components
@using System.Text
@using System.Runtime.Serialization
@inject ISnackbar Snackbar

<header class=" grid grid-cols-3 grid-rows-1 w-full bg-buttonbgblue items-center">
    <div class="ml-1 flex justify-start items-center gap-2">
        <MudIconButton Class="p-1 text-adlerdarkblue" Icon="@Icons.Material.Filled.Home" Size="Size.Large" Title=@Localizer["LearningWorld.Home.Hover"]      @onclick="OnClickMyLearningWorldsOverview"></MudIconButton>
        <MudDivider Vertical="true" FlexItem="true"/>
        <div class="relative">
            <MudIconButton Class="p-1 text-adlerdarkblue" Icon="@Icons.Material.Filled.Save" Title=@Localizer["LearningWorld.Save.Hover"] OnClick="TrySave">
            </MudIconButton>
            @if (SaveButtonHighlighted)
            {
                <span class="absolute inline-flex items-center justify-center w-3 h-3 text-xs font-bold text-white bg-red-500 border-2 border-white rounded-full -top-0 -end-0">
                </span>
            }
        </div>
        <div class="flex">
            <MudIconButton Class="p-1 undo-button text-adlerdarkblue" Icon="@Icons.Material.Filled.Undo" Disabled="!CanUndo"
                           Title=@Localizer["Functionality.Button.Undo.Hover"] OnClick="OnClickUndo">
            </MudIconButton>
            <MudIconButton Class="p-1 redo-button text-adlerdarkblue" Icon="@Icons.Material.Filled.Redo" Disabled="!CanRedo"
                           Title=@Localizer["Functionality.Button.Redo.Hover"] OnClick="OnClickRedo">
            </MudIconButton>
        </div>

        <div class="flex gap-2">
            <MudIconButton OnClick="@ExportLearningWorldToArchiveAsync"
                           Icon="@Icons.Material.Filled.Archive"
                           Class="w-8 h-8 text-adlerdarkblue disabled:bg-buttonbgblue p-2"
                           Title=@Localizer["ExportArchive.Hover"]
                           Disabled="@(SelectedViewModelsProvider.LearningWorld == null)">
            </MudIconButton>

            <MudIconButton OnClick="@GenerateLearningWorld"
                           Title="@Localizer["3DWorld.Generate.Hover"].Value"
                           Class="w-8 h-8 text-adlerdarkblue disabled:bg-buttonbgblue bg-adlergold-400 p-2 transform ease-in-out duration-75 active:drop-shadow-none hover:bg-adlergold-600 hover:text-adlerdarkblue"
                           Disabled="@(SelectedViewModelsProvider.LearningWorld == null)"
                           Icon="@Icons.Material.Filled.Publish">
            </MudIconButton>
        </div>

        @if (_debugBuild)
        {
            <button @onclick="DebugButtonClick" class="relative w-20 btn-standard p-2 bg-adlergold-400 hover:bg-adlergold-600 hover:text-adlerdarkblue disabled:bg-adlerbggradientto" title=@Localizer["3DWorld.Generate.Hover"] disabled="@(SelectedViewModelsProvider.LearningWorld == null)">
                <p class="absolute left-1 hover:-translate-x-[30%] transition-all duration-1000">DEBUG BACKUP</p>
            </button>
        }

        <MudPopover Open="@_popoverOpen" Fixed="false" Class="mt-12 ml-20 w-96 bg-adlerblue-600">
            <div class="flex flex-row">
                <p class="text-center text-lg pl-6 pt-6 text-white">@Localizer["MudPopover.Feedback.Survey.Text"]</p>
                <button class="flex-none w-5 h-5 text-adlergrey-200 font-bold text-lg hover:text-white" @onclick="TogglePopover" Icon="@Icons.Material.Filled.Close" title=@Localizer["Functionality.Button.Close.Hover"]>X</button>
            </div>
            <div class="flex justify-center items-center pb-6 pt-1">
                <a href="https://www.soscisurvey.de/autorentoolevaluation_gesamt" target="_blank" title=@Localizer["MudPopover.Feedback.Final.Hover"] class="w-7/12 btn-standard flex flex-row gap-2 justify-center items-center">
                    <img class="w-6 h-6 drop-shadow" src="/CustomIcons/feedback-icon-without-typo-nobg.png" alt="feedback-icon"/>
                    <p class="uppercase">@Localizer["MudPopover.Feedback.Final.Text"]</p>
                </a>
            </div>
        </MudPopover>

    </div>
    @if (SelectedViewModelsProvider.LearningWorld?.Name == null)
    {
        <div class="flex justify-center items-center gap-2 cursor-default">
            <img class="w-7 drop-shadow opacity-60" src="/CustomIcons/HeaderBar/autorentool-logo-icon.png" alt="authoringtool-logo"/>
            <p class="font-bold text-base 2xl:text-lg opacity-80 text-adlerdarkblue-800">@Localizer["AuthoringTool.Text"] @Localizer["AuthoringTool.Version"]</p>
        </div>
    }
    @if (SelectedViewModelsProvider.LearningWorld?.Name != null)
    {
        <div class="flex justify-center items-center gap-2 cursor-default">
            <img class="w-7 drop-shadow opacity-60" src="CustomIcons/World/world-icon.png" alt="learningworld">
            <p class="font-bold text-base 2xl:text-lg truncate w-56 xl:w-72 2xl:w-full opacity-80 text-adlerdarkblue-800" title="@SelectedViewModelsProvider.LearningWorld?.Name"> @SelectedViewModelsProvider.LearningWorld?.Name </p>
        </div>
    }

    <div class="flex justify-end items-center gap-2 border-solid">

        @if (SelectedViewModelsProvider.LearningWorld?.Name == null)
        {
            <a href="https://www.soscisurvey.de/autorentoolevaluationlernwelt/" target="_blank" title="@Localizer["Feedback.Button.UX.Hover"]">
                <div class="flex flex-row items-center gap-4">
                    <MudButton Class="btn-standard bg-adlerblue-600 test-base text-white font-semibold">@Localizer["Feedback.Text"]</MudButton>
                </div>
            </a>
        }
        else
        {
            <a href="https://www.soscisurvey.de/autorentoolevaluationlernraum/" target="_blank" title="@Localizer["Feedback.Button.UX.Hover"]">
                <div class="flex flex-row items-center gap-4">
                    <MudButton Class="btn-standard bg-adlerblue-600 test-base text-white font-semibold">@Localizer["Feedback.Text"]</MudButton>
                </div>
            </a>
        }

        <CultureSelector/>

        <MudIconButton Class="p-1 text-adlerdarkblue" OnClick="@ShowLearningOutcomesOverview" Disabled="@(SelectedViewModelsProvider.LearningWorld == null)" Icon="@learningOutcomeIcon" Title="@Localizer["LearningOutcomes.Overview"]"></MudIconButton>
        
        <MudMenu Dense="true" AnchorOrigin="Origin.BottomCenter" Icon="@icon">
            <MudMenuItem Disabled="true">@Localizer["HeaderBar.Help.UserManual"]</MudMenuItem>
            <MudMenuItem Disabled="true">@Localizer["HeaderBar.Help.Tutorial"]</MudMenuItem>
            <MudDivider></MudDivider>

            <MudListItem>
                <MudLink Underline="Underline.None" Class="text-adlertextgrey text-sm" OnClick="OpenFeedbackUX" title="@Localizer["MudPopover.Feedback.Final.Hover"]">@Localizer["Feedback.MenuItem.UX.Text"]</MudLink>
            </MudListItem>

            <MudListItem>
                <MudLink Underline="Underline.None" Class="text-adlertextgrey text-sm" OnClick="OpenFeedbackBug" title="@Localizer["Feedback.Button.Technical.Hover"]">@Localizer["Feedback.MenuItem.Technical.Text"]</MudLink>
            </MudListItem>

            <MudDivider></MudDivider>

            <MudListItem>
                <MudLink Underline="Underline.None" Class="text-adlertextgrey text-sm" OnClick="OpenAdLer" title="@Localizer["HeaderBar.Help.About.Hover"]">@Localizer["HeaderBar.Help.About"]</MudLink>
            </MudListItem>

        </MudMenu>

        <LmsLoginButton/>
        @if (PresentationLogic.RunningElectron)
        {
            <CloseAppButton/>
        }

    </div>
</header>

@code {

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    public IPresentationLogic PresentationLogic { get; set; }

    [Inject, AllowNull] public IShellWrapper ShellWrapper { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    internal NavigationManager NavManager { get; private init; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    private IStringLocalizer<HeaderBar> Localizer { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    private ISelectedViewModelsProvider SelectedViewModelsProvider { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    private IMediator Mediator { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    IDialogService DialogService { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    IErrorService ErrorService { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    private ILogger<HeaderBar> Logger { get; set; }

    private bool SaveButtonHighlighted => SelectedViewModelsProvider.LearningWorld is { UnsavedChanges: true };


    private bool _popoverOpen;
    private bool _debugBuild = false;

    protected override void OnInitialized()
    {
        base.OnInitialized();
#if DEBUG
        _debugBuild = true;
#endif
    }

    private void DebugButtonClick()
    {
#if DEBUG
        PresentationLogic.ConstructDebugBackup(SelectedViewModelsProvider.LearningWorld!);
#endif
    }

    private void TogglePopover()
    {
        _popoverOpen = !_popoverOpen;
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        PresentationLogic.OnCommandUndoRedoOrExecute += async (_, _) => await InvokeAsync(StateHasChanged);
        SelectedViewModelsProvider.PropertyChanged += OnSelectedViewModelsProviderPropertyChanged;
    }

    private void OnSelectedViewModelsProviderPropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnClickMyLearningWorldsOverview()
    {
        SelectedViewModelsProvider.SetLearningWorld(null, null);
        SelectedViewModelsProvider.SetLearningObjectInPathWay(null, null);
        SelectedViewModelsProvider.SetLearningElement(null, null);
        Mediator.CloseBothSides();
        NavManager.NavigateTo("/MyLearningWorldsOverview");
    }

    private bool CanUndo => PresentationLogic.CanUndo;
    private bool CanRedo => PresentationLogic.CanRedo;

    private async void GenerateLearningWorld()
    {
        var world = SelectedViewModelsProvider.LearningWorld;
        if (world == null) return;
        if (!IsLearningWorldValid(world)) return;
        //check if lms is connected here before generating the backup just to save time
        if (!await PresentationLogic.IsLmsConnected())
        {
            await ShowNotLoggedInDialog();
            return;
        }

        //present "Upload/Cancel" dialog
        var parameters = new DialogParameters
        {
            { "SubmitButtonText", Localizer["UploadLearningWorld.SubmitButtonText"].ToString() },
            { "SubmitButtonColor", Color.Success },
            {
                "DialogText",
                Localizer["Dialog.UploadLearningWorld.DialogText", world.Name].ToString()
            },
        };
        var options = new DialogOptions
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            DisableBackdropClick = true,
        };
        var dialog =
            await DialogService.ShowAsync<GenericCancellationConfirmationDialog>(Localizer["DialogService.UploadLearningWorld.Dialog"].ToString(), parameters,
                options);
        var result = await dialog.Result;

        //if not cancelled, upload LearningWorld
        if (result.Canceled) return;

        //present progress dialog
        var cancellationTokenSource = new CancellationTokenSource();
        var progress = new Progress<int>();
        options = new DialogOptions
        {
            CloseButton = false,
            CloseOnEscapeKey = false,
            DisableBackdropClick = true,
        };
        parameters = new DialogParameters
        {
            { nameof(UploadProgressDialog.Progress), progress },
            { nameof(UploadProgressDialog.CancellationTokenSource), cancellationTokenSource }
        };

        var uploadProgressDialogReference = await DialogService.ShowAsync<UploadProgressDialog>("Uploading world...", parameters, options);

        try
        {
            var response = await PresentationLogic.ConstructAndUploadBackupAsync(world, progress, cancellationTokenSource.Token);
            ShowUploadSuccessfulDialog(response);
        }
        catch (OperationCanceledException)
        {
            Snackbar.Add(Localizer["ExportCanceled.Snackbar.Message"], Severity.Warning);
            return;
        }
        catch (GeneratorException e)
        {
            ErrorService.SetError("An Error has occured during creation of a Backup File", e.Message);
            return;
        }
        catch (Exception ex)
        {
            ErrorService.SetError(ex);
        }
        finally
        {
            uploadProgressDialogReference.Close();
        }

        Snackbar.Add(Localizer["Export.SnackBar.Message"], Severity.Success);
        _popoverOpen = true;
        StateHasChanged();
    }

    private void ShowUploadSuccessfulDialog(UploadResponseViewModel response)
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            DisableBackdropClick = false,
        };

        var parameters = new DialogParameters
        {
            {
                nameof(UploadSuccessfulDialog.Url3D), response.World3DUrl
            },
            {
                nameof(UploadSuccessfulDialog.UrlMoodle), response.WorldLmsUrl
            },
            {
                nameof(UploadSuccessfulDialog.WorldName), response.WorldNameInLms
            }
        };
        DialogService.Show<UploadSuccessfulDialog>(Localizer["UploadLearningWorld.Success.Title"].ToString(), parameters, options);
    }

    private async Task ExportLearningWorldToArchiveAsync()
    {
        if (SelectedViewModelsProvider.LearningWorld is null) return;
        await PresentationLogic.ExportLearningWorldToArchiveAsync(SelectedViewModelsProvider.LearningWorld);
    }

    private bool IsLearningWorldValid(ILearningWorldViewModel world)
    {
        var errorString = new StringBuilder();
        errorString.Append("<ul>");

        if (world.LearningSpaces.Count == 0)
        {
            errorString.AppendLine($"<li> {Localizer["ErrorString.Missing.LearningSpace.Message"]} </li>");
        }

        foreach (var space in world.LearningSpaces)
        {
            if (!space.ContainedLearningElements.Any())
            {
                errorString.AppendLine($"<li> {Localizer["ErrorString.Missing.LearningElements.Message", space.Name]} </li>");
            }

            if (space.Points < space.RequiredPoints)
            {
                errorString.AppendLine($"<li> {Localizer["ErrorString.Insufficient.Points.Message", space.Name]} </li>");
            }
        }

        foreach (var (adaptivityContent, learningElement) in world.AllLearningElements
                     .Where(ele => ele.LearningContent is IAdaptivityContentViewModel)
                     .Select(ele => ((IAdaptivityContentViewModel)ele.LearningContent, ele)))
        {
            if (adaptivityContent.Tasks.Count <= 0) errorString.AppendLine($"<li> {Localizer["ErrorString.NoTasks.Message", learningElement.Name]} </li>");
            if (TaskReferencesNonexistantElement(adaptivityContent, world))
                errorString.AppendLine($"<li> {Localizer["ErrorString.TaskReferencesNonexistantElement.Message", learningElement.Name]} </li>");
            if (adaptivityContent.Tasks.Any(TaskReferencesUnplacedElement(world)))
                errorString.AppendLine($"<li> {Localizer["ErrorString.TaskReferencesUnplacedElement.Message", learningElement.Name]} </li>");
            var invalidSpaceReferences = ReferencesElementInSpaceAfterOwnSpace(learningElement, world);
            foreach (var referenceTuple in invalidSpaceReferences)
            {
                errorString.AppendLine($"<li> {Localizer["ErrorString.TaskReferencesElementInSpaceAfterOwnSpace.Message", learningElement.Name, referenceTuple.Space.Name, referenceTuple.Element.Name]} </li>");
            }
        }

        if (errorString.Length == "<ul>".Length) return true;

        errorString.Append("</ul>");

        Logger.LogError("LearningWorld is not valid: {ErrorString}", errorString);
        ErrorService.SetError(Localizer["Exception.InvalidLearningWorld.Message"], errorString.ToString());
        return false;
    }

    private bool TaskReferencesNonexistantElement(IAdaptivityContentViewModel adaptivityContent, ILearningWorldViewModel world)
    {
        var adaptivityContentReferencedIds = GetElementIdsContentReferences(adaptivityContent);
        return adaptivityContentReferencedIds.Any(id => world.AllLearningElements.All(ele => ele.Id != id));
    }

    private static Func<IAdaptivityTaskViewModel, bool> TaskReferencesUnplacedElement(ILearningWorldViewModel world) =>
        task => task.Questions
            .Any(question => question.Rules
                .Any(rule => rule.Action is ElementReferenceActionViewModel eravm &&
                             world.UnplacedLearningElements.Any(unplacedEle =>
                                 unplacedEle.Id == eravm.ElementId)));


    /// <summary>
    /// Checks if the given element references any elements that are placed in spaces which come AFTER the space it
    /// itself is in, in the partial ordering of spaces.
    /// </summary>
    private IEnumerable<(ILearningSpaceViewModel Space, ILearningElementViewModel Element)> ReferencesElementInSpaceAfterOwnSpace(ILearningElementViewModel element, ILearningWorldViewModel world)
    {
        var ownSpace = world.LearningSpaces.SingleOrDefault(space => space.ContainedLearningElements.Contains(element));
        //element isn't placed yet, can't say anything about it
        if (ownSpace is null) return Enumerable.Empty<(ILearningSpaceViewModel, ILearningElementViewModel)>();

        //find all the id's of elements that the adaptivity content of this element we are looking at references
        var adaptivityContent = (AdaptivityContentViewModel)element.LearningContent;
        var adaptivityContentReferencedIds = GetElementIdsContentReferences(adaptivityContent);

        //create a tuple of (space,ele) for every element in every space
        IEnumerable<(ILearningSpaceViewModel Space, ILearningElementViewModel Element)> spaceElementTuples = world.LearningSpaces
            .SelectMany(space => space.ContainedLearningElements
                .Select(ele => (space, ele)));

        //find all the tuples that contain an element that is referenced by the adaptivity content of the element we are looking at
        var spaceElementTuplesReferenced = spaceElementTuples.Where(tup => adaptivityContentReferencedIds.Contains(tup.Element.Id));

        //find all spaces that are after the space the element we are looking at is in
        var spacesAfterOwn = ownSpace.GetFollowingSpaces();

        //find all tuples that contain a space that is after our own space
        return spaceElementTuplesReferenced.Where(tup => spacesAfterOwn.Contains(tup.Space));
    }

    private static IEnumerable<Guid> GetElementIdsContentReferences(IAdaptivityContentViewModel adaptivityContent)
    {
        return adaptivityContent.Tasks
            .SelectMany(task => task.Questions
                .SelectMany(question => question.Rules
                    .Select(rule => rule.Action)
                    .Where(action => action is ElementReferenceActionViewModel)
                    .Cast<ElementReferenceActionViewModel>()
                    .Select(action => action.ElementId)));
    }

    private async Task ShowNotLoggedInDialog()
    {
        //present Info dialog
        var parameters = new DialogParameters
        {
            { "OkButtonText", Localizer["ShowNotLoggedInDialog.OkButtonText"].ToString() },
            { "OkButtonColor", Color.Primary },
            {
                "DialogText",
                (MarkupString)Localizer["Dialog.NotLoggedIn.Message"].ToString()
            },
        };
        var options = new DialogOptions
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            DisableBackdropClick = false,
        };
        await DialogService.ShowAsync<GenericInfoDialog>(Localizer["DialogService.NotLoggedIn.Title"].ToString(), parameters, options);
    }

    private void OnClickUndo()
    {
        try
        {
            PresentationLogic.UndoCommand();
        }
        catch (UndoException e)
        {
            ErrorService.SetError("An error occurred while attempting to undo the last action", e.Message);
        }
    }

    private void OnClickRedo()
    {
        try
        {
            PresentationLogic.RedoCommand();
        }
        catch (RedoException e)
        {
            ErrorService.SetError("An error occurred while attempting to redo the last undone action", e.Message);
        }
    }

    private void TrySave()
    {
        var learningWorldViewModel = SelectedViewModelsProvider.LearningWorld;
        if (learningWorldViewModel is null) return;
        try
        {
            PresentationLogic.SaveLearningWorld(learningWorldViewModel);
            var snackbarString = Localizer["SaveWorld.Success.Snackbar.Message", learningWorldViewModel.Name].Value;
            Snackbar.Add(snackbarString, Severity.Success);
        }
        catch (SerializationException e)
        {
            ErrorService.SetError("An error occurred while attempting to save the LearningWorld", e.Message);
        }
        catch (InvalidOperationException e)
        {
            ErrorService.SetError("An error occurred while attempting to save the LearningWorld", e.Message);
        }
        catch (OperationCanceledException)
        {
            Snackbar.Add("Save LearningWorld canceled", Severity.Warning);
        }
    }

    private void OpenAdLer() => ShellWrapper.OpenPathAsync("https://www.projekt-adler.eu");

    private void ShowLearningOutcomesOverview()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            DisableBackdropClick = false,
            FullWidth = true,
            MaxWidth = MaxWidth.Medium
        };

        var parameters = new DialogParameters
        {
            {
                nameof(LearningOutcomesWorldOverview.LearningWorld), SelectedViewModelsProvider.LearningWorld
            }
        };
        DialogService.Show<LearningOutcomesWorldOverview>("", parameters, options);
    }

    private string learningOutcomeIcon => SelectedViewModelsProvider.LearningWorld == null ? learningOutcomeIconDeactivated : learningOutcomeIconActivated;

    const string learningOutcomeIconActivated =
        @"<?xml version=""1.0"" encoding=""UTF-8""?>
            <svg id=""uuid-347490b4-1d53-493d-bc86-b0ca80e39b63"" data-name=""R-LearningOutcome"" xmlns=""http://www.w3.org/2000/svg"" viewBox=""0 0 2000 2000"">
                <circle cx=""1004.73"" cy=""1004.77"" r=""892.6"" style=""fill: none; stroke: #2e3a4d; stroke-miterlimit: 10; stroke-width: 200px;""/>
                    <circle cx=""1007.35"" cy=""1003.55"" r=""526.15"" style=""fill: none; stroke: #2e3a4d; stroke-miterlimit: 10; stroke-width: 200px;""/>
                        <line x1=""991.71"" y1=""-15.05"" x2=""991.71"" y2=""801.04"" style=""fill: none; stroke: #172d4d; stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 50px;""/>
                            <line x1=""1225.61"" y1=""1013.66"" x2=""2043.43"" y2=""1013.66"" style=""fill: none; stroke: #172d4d; stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 50px;""/>
                                <circle cx=""1000.71"" cy=""984.34"" r=""243.06"" style=""fill: #172d4d; stroke-width: 0px;""/>
                                    <line x1=""1016.48"" y1=""986.81"" x2=""1714.73"" y2=""288.56"" style=""fill: none; stroke: #e9f2fa; stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 172px;""/>
                                        <line x1=""1015.48"" y1=""986.81"" x2=""1713.73"" y2=""288.56"" style=""fill: none; stroke: #172d4d; stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 120px;""/>
                                            <g>
                                                <rect x=""1562.75"" y=""219.03"" width=""214.35"" height=""214.35"" transform=""translate(1257.75 1977.01) rotate(-87.03)"" style=""fill: #172d4d; stroke-width: 0px;""/>
                                                    <polyline points=""1771.4 438.78 1782.49 224.72 1996.55 235.81"" style=""fill: #172d4d; stroke-width: 0px;""/>
                                                        <polyline points=""1793.58 10.66 1782.49 224.72 1568.43 213.63"" style=""fill: #172d4d; stroke-width: 0px;""/>
                                                            </g>
                                                                <line x1=""0"" y1=""1005.85"" x2=""817.09"" y2=""1005.85"" style=""fill: none; stroke: #172d4d; stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 50px;""/>
                                                                    <line x1=""987.71"" y1=""1221.81"" x2=""987.71"" y2=""2029.06"" style=""fill: none; stroke: #172d4d; stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 50px;""/>
                                                                        </svg>";

    const string learningOutcomeIconDeactivated =
        @"<?xml version=""1.0"" encoding=""UTF-8""?>
            <svg id=""uuid-347490b4-1d53-493d-bc86-b0ca80e39b63"" data-name=""R-LearningOutcome"" xmlns=""http://www.w3.org/2000/svg"" viewBox=""0 0 2000 2000"">
                <circle cx=""1004.73"" cy=""1004.77"" r=""892.6"" style=""fill: none; stroke: rgb(179,179,179); stroke-miterlimit: 10; stroke-width: 200px;""/>
                    <circle cx=""1007.35"" cy=""1003.55"" r=""526.15"" style=""fill: none; stroke: rgb(179,179,179); stroke-miterlimit: 10; stroke-width: 200px;""/>
                        <line x1=""991.71"" y1=""-15.05"" x2=""991.71"" y2=""801.04"" style=""fill: none; stroke: rgb(179,179,179); stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 50px;""/>
                            <line x1=""1225.61"" y1=""1013.66"" x2=""2043.43"" y2=""1013.66"" style=""fill: none; stroke: rgb(179,179,179); stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 50px;""/>
                                <circle cx=""1000.71"" cy=""984.34"" r=""243.06"" style=""fill: rgb(179,179,179); stroke-width: 0px;""/>
                                    <line x1=""1016.48"" y1=""986.81"" x2=""1714.73"" y2=""288.56"" style=""fill: none; stroke: #e9f2fa; stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 172px;""/>
                                        <line x1=""1015.48"" y1=""986.81"" x2=""1713.73"" y2=""288.56"" style=""fill: none; stroke: rgb(179,179,179); stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 120px;""/>
                                            <g>
                                                <rect x=""1562.75"" y=""219.03"" width=""214.35"" height=""214.35"" transform=""translate(1257.75 1977.01) rotate(-87.03)"" style=""fill: rgb(179,179,179); stroke-width: 0px;""/>
                                                    <polyline points=""1771.4 438.78 1782.49 224.72 1996.55 235.81"" style=""fill: rgb(179,179,179); stroke-width: 0px;""/>
                                                        <polyline points=""1793.58 10.66 1782.49 224.72 1568.43 213.63"" style=""fill: rgb(179,179,179); stroke-width: 0px;""/>
                                                            </g>
                                                                <line x1=""0"" y1=""1005.85"" x2=""817.09"" y2=""1005.85"" style=""fill: none; stroke:rgb(179,179,179); stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 50px;""/>
                                                                    <line x1=""987.71"" y1=""1221.81"" x2=""987.71"" y2=""2029.06"" style=""fill: none; stroke: rgb(179,179,179); stroke-linecap: round; stroke-miterlimit: 10; stroke-width: 50px;""/>
                                                                        </svg>";

    private void OpenFeedbackUX() => ShellWrapper.OpenPathAsync("https://www.soscisurvey.de/autorentoolevaluation_gesamt");

    private void OpenFeedbackBug() => ShellWrapper.OpenPathAsync("https://bugreport.projekt-adler.eu");

    private string icon = help;

    const string help =
        @"<?xml version=""1.0"" encoding=""UTF-8""?>
        <svg id=""Ebene_1"" data-name=""Ebene 1"" xmlns=""http://www.w3.org/2000/svg"" viewBox=""0 0 2000 2000"">
            <defs>
                <style>
                    .cls-1 {
                        fill: #172d4d;
                    }

                        .cls-1, .cls-2 {
                            stroke-width: 0px;
                        }

                            .cls-2 {
                                fill: #e9f2fa;
                            }
    </style>
    </defs>
    <circle class=""cls-1"" cx=""1000"" cy=""1002"" r=""979""/>
    <path class=""cls-2"" d=""m544.25,614.03s161.83-383.69,652.2-240.32c2.7.79,5.38,1.68,8.02,2.66,193.68,72.11,231.78,155.81,262.57,236.47,1.08,2.83,2.06,5.7,2.92,8.6,110.36,376.9-370.36,480.48-375.65,635.86-.76,127.58-322.4,150.5-229.19-142.86,79.89-251.46,305.72-177.93,320.02-343.75,5.03-58.36,4.33-105.36-37.37-151.01-14.12-15.46-32.17-26.82-52.08-33.31-336.37-109.7-265.48,333.41-498.75,220.87-43.55-21.01-71.01-65.56-69.45-113.89,1.45-44.95,16.76-79.31,16.76-79.31Z""/>
    <ellipse class=""cls-2"" cx=""986.74"" cy=""1572.63"" rx=""133.38"" ry=""134.89""/>
    </svg>";

}