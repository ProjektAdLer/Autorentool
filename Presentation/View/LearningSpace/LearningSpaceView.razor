@using Presentation.PresentationLogic.LearningSpace
@using Presentation.PresentationLogic.LearningSpace.SpaceLayout.FloorPlans
@using Presentation.PresentationLogic.SelectedViewModels
@using Presentation.View.LearningElement
@using Shared
@using Microsoft.Extensions.Localization
@using System.Text
@using Presentation.PresentationLogic.LearningElement

@if (LearningSpaceP.LearningSpaceVm != null)
{
    @if (!LearningSpaceP.LearningSpaceVm.AdvancedMode)
    {
        <div class="mx-2 rounded-lg">
            <div class="flex justify-center p-2">
                <h2 class="text-xl text-center font-bold text-adlergrey-500 mx-2">@Localizer["LearningSpace.Title.Text"]</h2>
            </div>
        </div>


        <div class="p-2 flex justify-start space-x-2">
            <img class="w-8" src="CustomIcons/space-icon_nobg.png" alt="learningspace">
            <p class="text-lg text-adlerblue-600 truncate hover:text-clip">@LearningSpaceP.LearningSpaceVm.Name</p>
        </div>

        @if (SelectedViewModelsProvider?.LearningObjectInPathWay != null)
        {
            <section class="p-2 gap-1 flex flex-col justify-start">
                <div class="gap-8 flex justify-between items-start">
                    <label id="learning-element-info" class="font-medium text-lg flex flex-col justify-stretch">
                        <h3 class="text-base text-adlerblue-600 space-theme">
                            <span class="text-adlergrey-600">@Localizer["LearningSpace.SpaceTheme.Text"] </span>@LearningSpaceP.LearningSpaceVm?.Theme
                        </h3>
                        @*<h3 class="text-base text-adlerblue-600"><span class="text-adlergrey-600">Selected learning element: </span> @SelectedViewModelsProvider.LearningElement.Name</h3>*@
                        <h3 class="text-base text-adlerblue-600 flex-initial break-all space-goals">
                            <span class="text-adlergrey-600">@Localizer["LearningSpace.SpaceGoals.Text"] </span>@LearningSpaceP.LearningSpaceVm?.Goals
                        </h3>
                    </label>
                    <div class="min-w-max">
                        <h3 class="text-base text-adlerblue-600 space-workload">
                            <span class="text-adlergrey-600">@Localizer["LearningSpace.SpaceWorkload.Text"] </span> @LearningSpaceP.LearningSpaceVm?.Workload<span class="text-adlergrey-600"> min.</span>
                        </h3>
                        <h3 class="text-base text-adlerblue-600 space-points">
                            <span class="text-adlergrey-600">@Localizer["LearningSpace.SpacePoints.Text"] </span> @LearningSpaceP.LearningSpaceVm?.Points
                        </h3>
                        @ChildContent
                    </div>
                </div>
                <div class="flex justify-start">
                    <button class="relative btn-standard delete-learning-element w-14" @onclick="DeleteSelectedLearningElement" title=@Localizer["LearningSpace.Button.DeleteLearningElement.Title"]>
                        <img src="CustomIcons/learningelements-icon-nobg.png" alt="Delete learning element" class="absolute opacity-50 w-8 h-8">
                        <MudIcon Icon="@Icons.Material.Filled.Delete" Class="absolute"></MudIcon>
                    </button>
                    <button class="relative btn-standard save-learning-element w-14" @onclick="SaveSelectedLearningElementAsync" title=@Localizer["LearningSpace.Button.SaveLearningElement.Title"]>
                        <img src="CustomIcons/learningelements-icon-nobg.png" alt="Save learning element" class="absolute opacity-50 w-8 h-8">
                        <MudIcon Icon="@Icons.Material.Filled.Save" Class="absolute"></MudIcon>
                    </button>
                    <button class="relative btn-standard show-learning-element-content w-14" @onclick="ShowSelectedElementContentAsync" title=@Localizer["LearningSpace.Button.ShowLearningElement.Title"]>
                        <img src="CustomIcons/learningelements-icon-nobg.png" alt="Show learning element" class="absolute opacity-50 w-8 h-8">
                        <MudIcon Icon="@Icons.Material.Filled.RemoveRedEye" Class="absolute"></MudIcon>
                    </button>
                </div>
            </section>
        }
        <div class="w-full min-h-[400px] bg-adlerbgbright border-2 border-b-adlerdeactivated">
            @*style="width: 90%; height: 400px; border: 2px solid;"*@
            <div class="layout-shadow w-full h-full">
                <div class="mt-15 mx-auto layout w-[98%] h-[375px] 2xl:h-[420px] 1080p:h-[645px] 2500p:h-[1000px] 3000p:h-[1150px] 3700p:h-[1675px]" style="@GetCornerPointsString(LearningSpaceP.LearningSpaceVm.LearningSpaceLayout.FloorPlanViewModel)">

                    @for (var i = 0; i < LearningSpaceP.LearningSpaceVm.LearningSpaceLayout.Capacity; i++)
                    {
                        var x = i;
                        var identifier = LearningSpaceP.LearningSpaceVm.Id.ToString() + x;

                        <MudDropZone T="ILearningElementViewModel" Identifier="@identifier"
                                     Class="@GetSlotStyleString(x)"
                                     style="@GetSlotPositionString(LearningSpaceP.LearningSpaceVm.LearningSpaceLayout.FloorPlanViewModel, x)"
                                     @onclick="() => ClickOnSlot(x)">
                            <ItemRenderer>
                                <DragDropLearningElement
                                    LearningElement="@context"
                                    OnShowLearningElementContent="@LearningSpaceP.ShowElementContent"
                                    OnEditLearningElement="@LearningSpaceP.ClickedLearningElement"
                                    OnDeleteLearningElement="@LearningSpaceP.DeleteLearningElement"
                                    OnClicked="@LearningSpaceP.ClickedLearningElement"/>
                            </ItemRenderer>
                            <ChildContent>
                                @if (!LearningSpaceP.LearningSpaceVm.LearningSpaceLayout.LearningElements.ContainsKey(x))
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Add" Style="font-size: 2rem;" Class="text-white"></MudIcon>
                                }
                            </ChildContent>
                        </MudDropZone>
                    }
                </div>
            </div>
        </div>
    }
    else

    {
        <div class="mx-2 rounded-lg">
            <div class="flex justify-center p-2">
                <h2 class="text-xl text-center font-bold text-adlergrey-500 mx-2">Advanced Space Editor</h2>
            </div>
        </div>

        <section class="p-2 gap-1 flex flex-col justify-start">
            <div class="gap-8 flex justify-between items-start">
                <label id="learning-element-info" class="font-medium text-lg flex flex-col justify-stretch">
                    <h3 class="text-base text-adlerblue-600 space-theme">
                        <span class="text-adlergrey-600">@Localizer["LearningSpace.SpaceTheme.Text"] </span>@LearningSpaceP.LearningSpaceVm?.Theme
                    </h3>
                    @*<h3 class="text-base text-adlerblue-600"><span class="text-adlergrey-600">Selected learning element: </span> @SelectedViewModelsProvider.LearningElement.Name</h3>*@
                    <h3 class="text-base text-adlerblue-600 flex-initial break-all space-goals">
                        <span class="text-adlergrey-600">@Localizer["LearningSpace.SpaceGoals.Text"] </span>@LearningSpaceP.LearningSpaceVm?.Goals
                    </h3>
                </label>
                <div class="min-w-max">
                    <h3 class="text-base text-adlerblue-600 space-workload">
                        <span class="text-adlergrey-600">@Localizer["LearningSpace.SpaceWorkload.Text"] </span> @LearningSpaceP.LearningSpaceVm?.Workload<span class="text-adlergrey-600"> min.</span>
                    </h3>
                    <h3 class="text-base text-adlerblue-600 space-points">
                        <span class="text-adlergrey-600">@Localizer["LearningSpace.SpacePoints.Text"] </span> @LearningSpaceP.LearningSpaceVm?.Points
                    </h3>
                    @ChildContent
                </div>
            </div>

            <div class="w-full min-h-[300px] bg-adlerbgbright border-2 border-b-adlerdeactivated">
                @*style="width: 90%; height: 400px; border: 2px solid;"*@
                <div class="layout-shadow w-full h-full">
                    <div class="mt-15 mx-auto layout w-[98%] h-[375px] 2xl:h-[420px] 1080p:h-[645px] 2500p:h-[1000px] 3000p:h-[1150px] 3700p:h-[1675px]" style="@GetCornerPointsString(LearningSpaceP.LearningSpaceVm.LearningSpaceLayout.FloorPlanViewModel)">

                        Raum content
                    </div>

                </div>

            </div>
            <div class="w-full min-h-[90px] bg-adlerbgbright border-2 border-b-adlerdeactivated">
                <nav class="bg-gray-300">
                    <div class="relative flex mx-auto max-w-7xl px-2 sm:px-6 lg:px-8 h-8 items-center justify-between">
                        <div class="items-stretch justify-start hidden sm:ml-6 sm:block">
                            <div class="flex space-x-4">
                                <button
                                    class="@GetMenuStyleString(MenuFocus.LearningElements) rounded-md px-2 py-1 text-sm font-medium"
                                    @onclick="() => _menuFocus = MenuFocus.LearningElements">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete"></MudIcon>
                                    Lernelemente
                                </button>
                                @*Flag *@
                                <button
                                    class="@GetMenuStyleString(MenuFocus.DecoObjects) rounded-md px-2 py-1 text-sm font-medium"
                                    @onclick="() => _menuFocus = MenuFocus.DecoObjects">
                                    Deco Objekte
                                </button>
                                @*Fan *@
                                <button
                                    class="@GetMenuStyleString(MenuFocus.Doors) rounded-md px-2 py-1 text-sm font-medium"
                                    @onclick="() => _menuFocus = MenuFocus.Doors">
                                    Türen
                                </button>
                                <button
                                    class="@GetMenuStyleString(MenuFocus.Windows) rounded-md px-2 py-1 text-sm font-medium"
                                    @onclick="() => _menuFocus = MenuFocus.Windows">
                                    Fenster
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
                <div>
                    Menu Inhalt
                </div>
            </div>
        </section>
    }
}
@if (LearningSpaceP.ReplaceLearningElementDialogOpen && _showingReplaceLearningElementDialog == false)
{
    @ShowReplaceLearningElementDialog()
}

@code {
#pragma warning disable CS8618 // injected by framework - n.stich
    [Inject]
    public ILearningSpacePresenter LearningSpaceP { get; set; }

    [Inject]
    IDialogService DialogService { get; set; }

    [Inject]
    private IStringLocalizer<LearningSpaceView> Localizer { get; set; }
#pragma warning restore CS8618

    // Menu Button Stuff

    private enum MenuFocus
    {
        LearningElements,
        DecoObjects,
        Doors,
        Windows
    }

    private MenuFocus _menuFocus;

    private string GetMenuStyleString(MenuFocus buttonType)
    {
        return buttonType == _menuFocus ? "bg-gray-900 text-white " : "text-gray-400 hover:bg-gray-700 hover:text-white ";
    }


    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [CascadingParameter(Name = "TriggerMasterLayoutStateHasChanged")]
    private Action TriggerMasterLayoutStateHasChanged { get; set; }

    [Inject]
    public ISelectedViewModelsProvider SelectedViewModelsProvider { get; set; }

    //TODO: Instead of setting a value here we need some sort of central service that we can notify about the error to
    //then display it in the UI - n.stich
    internal ExceptionWrapper? ErrorState { get; private set; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        LearningSpaceP.OnCommandUndoRedoOrExecute += async (_, args) =>
        {
            await InvokeAsync(StateHasChanged);
            if (args.CommandName is "CreateLearningElement" or "LoadLearningElement" or 
                "PlaceLearningElementInLayoutFromUnplaced" or "ChangeLearningSpaceLayout" or 
                "PlaceLearningElementInLayoutFromLayout" or "CreateLearningSpace" or "RemoveLearningElementFromLayout")
            {
                await InvokeAsync(TriggerMasterLayoutStateHasChanged);
            }
        };
        LearningSpaceP.PropertyChanged += (sender, earg) =>
        {
            if (earg.PropertyName == nameof(LearningSpaceP.LearningSpaceVm)) InvokeAsync(TriggerMasterLayoutStateHasChanged);
        };
    }

    private bool _showingReplaceLearningElementDialog = false;


    private void DeleteSelectedLearningElement()
    {
        LearningSpaceP.DeleteSelectedLearningElement();
    }

    private async Task LoadLearningElementAsync()
    {
    //TODO: Remove parameterless method and use the one with the parameter - AW
        try
        {
            await LoadLearningElementAsync(0);
        }
        catch (Exception e)
        {
            ErrorState = new ExceptionWrapper("", e);
        }
    }

    private async Task LoadLearningElementAsync(int slotIndex)
    {
        try
        {
            await LearningSpaceP.LoadLearningElementAsync(slotIndex);
        }
        catch (OperationCanceledException)
        {
    //nothing to do, show notification?
        }
        catch (Exception exception)
        {
            ErrorState = new ExceptionWrapper(Localizer["Error.ExceptionWrapper.LoadLearningElement.Message"], exception);
        }
        finally
        {
    //we need to tell blazor explicitly to re-render our component after we added the loaded learning element
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SaveSelectedLearningElementAsync()
    {
        try
        {
            await LearningSpaceP.SaveSelectedLearningElementAsync();
        }
        catch (OperationCanceledException)
        {
    //nothing to do, show notification?
        }
        catch (Exception exception)
        {
            ErrorState = new ExceptionWrapper(Localizer["Error.ExceptionWrapper.SaveLearningElement.Message"], exception);
        }
        finally
        {
    //we need to tell blazor explicitly to re-render our component after we added the loaded learning element
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ShowSelectedElementContentAsync()
    {
        try
        {
            await LearningSpaceP.ShowSelectedElementContentAsync();
        }
        catch (OperationCanceledException)
        {
        }
        catch (Exception exception)
        {
            ErrorState = new ExceptionWrapper(Localizer["Error.ExceptionWrapper.ShowLearningElementContent.Message"], exception);
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void EditLearningElement(int slotIndex)
    {
        LearningSpaceP.EditLearningElement(slotIndex);
    }

    private void OnReplaceElementDialogClose(DialogResult closeResult)
    {
        LearningSpaceP.OnReplaceLearningElementDialogClose(closeResult);
        InvokeAsync(StateHasChanged);
    }

    private void SetLearningSpaceLayout(string floorPlanName)
    {
        Enum.TryParse(floorPlanName, out FloorPlanEnum floorPlan);
        LearningSpaceP.SetLearningSpaceLayout(floorPlan);
        InvokeAsync(StateHasChanged);
    }

    private string GetCornerPointsString(IFloorPlanViewModel floorPlan)
    {
        var cornerPointsString = new StringBuilder();
        cornerPointsString.Append("clip-path: polygon(");
        foreach (var cornerPoint in floorPlan.CornerPoints)
        {
            cornerPointsString.Append($"{cornerPoint.X}% {cornerPoint.Y}%, ");
        }
        if (floorPlan.CornerPoints.Any())
        {
            cornerPointsString.Length -= 2;
        }
        else
        {
            cornerPointsString.Append("0% 0%");
        }
        cornerPointsString.Append(");");
        return cornerPointsString.ToString();
    }

    private string GetSlotPositionString(IFloorPlanViewModel floorPlanViewModel, int position)
    {
        var slotPosition = floorPlanViewModel.ElementSlotPositions[position];
        var slotPositionString = new StringBuilder();
        slotPositionString.Append("position: absolute; ");
        slotPositionString.Append($"top: {slotPosition.Y}%; ");
        slotPositionString.Append($"left: {slotPosition.X}%; ");
        slotPositionString.Append("transform: translate(-80%, -110%);");
        return slotPositionString.ToString();
    }

    private string GetSlotStyleString(int position)
    {
        if (LearningSpaceP.LearningSpaceVm == null) return "";

        if (SelectedViewModelsProvider.ActiveSlotInSpace == position)
        {
            return "rounded-lg border-2 bg-adlergreen border-adlergreen bg-opacity-30 mud-border-lines-default text-white p-6 m-8 w-28 h-3 flex justify-center items-center";
        }
        return "rounded-lg border-2 border-adlerblue bg-adlerdeactivatedtext mud-border-lines-default p-6 m-8 w-28 h-3 flex justify-center items-center hover:bg-adlerblue-300";
    }

    private string GetSlotIconString(int position)
    {
        if (LearningSpaceP.LearningSpaceVm == null) return "";

        if (LearningSpaceP.LearningSpaceVm.LearningSpaceLayout.LearningElements.ContainsKey(position))
        {
            return "";
        }
        return "@Icons.Material.Filled.Add";
    }

    private void ClickOnSlot(int i)
    {
        LearningSpaceP.ClickOnSlot(i);
    }

    private async Task ShowReplaceLearningElementDialog()
    {
        _showingReplaceLearningElementDialog = true;
        var dialog = await DialogService.ShowAsync<ReplaceLearningElementDialog>(@Localizer["ShowReplaceLearningElementDialog.Dialog.ReplaceLearningElement"]);
        var result = await dialog.Result;
        LearningSpaceP.OnReplaceLearningElementDialogClose(result);
        _showingReplaceLearningElementDialog = false;
    }

}