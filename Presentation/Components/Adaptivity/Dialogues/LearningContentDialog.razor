@using System.Diagnostics.CodeAnalysis
@using AutoMapper
@using Microsoft.Extensions.Localization
@using Presentation.Components.Forms.Models
@using Presentation.PresentationLogic.LearningWorld
@inherits MudBaseInput<ILearningContentFormModel>

<p class="text-sm pl-6">@Localizer["LearningContentDialog.LearningMaterial.Dialog.Subtitle"]</p>
<MudTable T="ILearningContentFormModel"
          Items="WorldPresenter.GetAllContent().Select(vm => Mapper.Map<ILearningContentFormModel>(vm))"
          Hover="true"
          Height="500px"
          Breakpoint="Breakpoint.Sm"
          RowClass="cursor-pointer"
          OnRowClick="RowClickEvent"
          Filter="Filter"
          RowClassFunc="@SelectedRowClassFunc">
    <ToolBarContent>
        <div class="bg-adlerbgbright rounded-lg flex flex-row gap-2 pb-2 px-2 w-full">
            <MudTextField @bind-Value="_searchString"
                          Immediate="true"
                          Placeholder="@Localizer["LearningContentDialog.LearningMaterial.Search"]"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Outlined.Search"/>
        </div>
    </ToolBarContent>
    <HeaderContent>
        <MudTh></MudTh>
        <MudTh Class="p-0">Name</MudTh>
        <MudTh Class="p-0">Type</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd Class="p-0">
            <MudIconButton Icon="@Icons.Material.Filled.RemoveRedEye"
                           Class="show-content-preview py-2"
                           Title="@Localizer["LearningContentDialog.LearningMaterial.Preview"]"/>
        </MudTd>
        <MudTd Class="p-0" DataLabel="Name">
            <MudTooltip Text="@context.Name"
                        Arrow="true"
                        Placement="Placement.Right"
                        Class="bg-adlergrey-200 shadow-xl text-adlergrey-800"
                        Duration="Double.Epsilon">
                <p class="pt-2 cursor-pointer max-w-[16rem] truncate text-ellipsis overflow-hidden">@context.Name</p>
            </MudTooltip>
        </MudTd>
        <MudTd Class="py-0 pl-0 cursor-default" DataLabel="Type">
            @if (context is FileContentFormModel fileContentContext)
            {
                @fileContentContext.Type
            }
            else
            {
                <span>Link</span>
            }
        </MudTd>
    </RowTemplate>
</MudTable>


@code {
    [CascadingParameter] public MudDialogInstance? MudDialog { get; set; }

    [Parameter, EditorRequired] public ILearningContentFormModel? LearningContent { get; set; }
    
    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types - n.stich
    internal IStringLocalizer<LearningContentDialog> Localizer { get; set; }

    [Inject, AllowNull] internal ILearningWorldPresenter WorldPresenter { get; set; }

    [Inject, AllowNull] internal IMapper Mapper { get; set; }

    private string? _searchString;

    private void RowClickEvent(TableRowClickEventArgs<ILearningContentFormModel> tableRowClickEventArgs)
    {
        MudDialog?.Close(DialogResult.Ok(tableRowClickEventArgs.Item));
    }

    private string SelectedRowClassFunc(ILearningContentFormModel element, int rowNumber)
    {
        return element.Equals(LearningContent) ? "bg-adlergrey-100" : string.Empty;
    }

    private bool Filter(ILearningContentFormModel element) =>
        FilterInternal(element, _searchString);

    private bool FilterInternal(ILearningContentFormModel element, string? searchString) => FilterInternal(ILearningContentFormModel.GetSearchableStrings(element), searchString);

    private bool FilterInternal(IEnumerable<string> searchableStrings, string? searchString)
    {
        return string.IsNullOrWhiteSpace(searchString) || searchableStrings.Any(str => str.ToLowerInvariant().Contains(searchString.ToLower()));
    }

}