@using Presentation.PresentationLogic.API
@using Presentation.PresentationLogic.LearningContent.AdaptivityContent
@using Presentation.PresentationLogic.LearningContent.AdaptivityContent.Question
@using Shared.Adaptivity
@using Microsoft.Extensions.Localization
@using AutoMapper
@using BusinessLogic.Entities.LearningContent.Adaptivity
@using Presentation.Components.Forms
@using System.Diagnostics.CodeAnalysis
<p class="text-sm 2xl:text-lg mx-6">@Localizer["AdaptivityContentDialog.Subtitle"]</p>
<MudTable @ref="@_table" Items="@MyContent.Tasks" Height="500px" Outlined="true" Class="rounded-lg border-4 border-adlerdarkblue-100 m-4"
          FixedHeader="true" r="false" CustomFooter="true" Bordered="true">
    <ColGroup>
        <col/>
        <col style="width: 15px;"/>
        <col/>
        <col/>
        <col/>
    </ColGroup>
    <HeaderContent>
        <MudTh Class="font-bold text-adlerdarkblue-800 text-lg bg-adlergrey-100">@Localizer["AdaptivityContentDialog.Table.Header.Tasks"]</MudTh>
        <MudTh Class="px-2 leading-tight font-bold text-adlerdarkblue-800 break-words bg-adlergrey-100">@Localizer["AdaptivityContentDialog.Table.Header.RequiredTask"]</MudTh>
        <MudTh Class="text-adlerdarkblue-800 font-bold bg-adlerbgbright">
            <div class="flex justify-center items-center pa-3 gap-2">
                <MudText Class="font-bold text-sm pt-1">@Localizer["AdaptivityContentDialog.Table.Header.Easy"]</MudText>
                <MudIcon Class="drop-shadow" Icon="@CustomIcons.DifficultyPolygonEasy"></MudIcon>
            </div>
        </MudTh>
        <MudTh Class="text-adlerdarkblue-800 font-bold bg-adlerbgbright">
            <div class="flex justify-center items-center pa-3 gap-2">
                <MudText Class="font-bold text-sm pt-1">@Localizer["AdaptivityContentDialog.Table.Header.Medium"]</MudText>
                <MudIcon Class="drop-shadow" Icon="@CustomIcons.DifficultyPolygonMedium"></MudIcon>
            </div>
        </MudTh>
        <MudTh Class="text-adlerdarkblue-800 font-bold bg-adlerbgbright">
            <div class="flex justify-center items-center pa-3 gap-2">
                <MudText Class="font-bold text-sm pt-1">@Localizer["AdaptivityContentDialog.Table.Header.Hard"]</MudText>
                <MudIcon Class="drop-shadow" Icon="@CustomIcons.DifficultyPolygonHard"></MudIcon>
            </div>
        </MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Tasks"]">
            <MudForm Model="context" @ref="_nameMudFormRefs[context]">
                <span class="inline-flex">
                    <MudTextField Class="break-words" T="string" @bind-Value="@_nameValues[context]" Required="true"
                                  RequiredError="@Localizer["AdaptivityContentDialog.Table.Field.Name.RequiredError.Text"]"
                                  DebounceInterval="300" OnDebounceIntervalElapsed="s => RenameTask(context, s)"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Remove" OnClick="() => RemoveTask(context)"/>
                </span>
            </MudForm>
        </MudTd>
        <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.RequiredTask"]">
            <div class="flex justify-center">
            <MudCheckBox T="bool?" Checked="@(context.MinimumRequiredDifficulty != null)" Disabled="true"/>
            </div>
        </MudTd>
        @foreach (var difficulty in Enum.GetValues(typeof(QuestionDifficulty)).Cast<QuestionDifficulty>())
        {
            <MudTd Class="p-1" DataLabel="@Localizer["AdaptivityContentDialog.Table.Header." + difficulty]">
                @if (GetTaskQuestionWithQuestionDifficulty(context, difficulty) is {} question)
                {
                    <div class="flex flex-row justify-between">
                        <div class="flex items-center justify-center">
                            <MudTooltip Placement="Placement.Top" Duration="double.Epsilon" Style="background: transparent;">
                                <ChildContent>
                                    <MudIconButton Disabled="true" Icon="@Icons.Material.Filled.RemoveRedEye"></MudIconButton>
                                </ChildContent>
                                <TooltipContent>
                                    <AdaptivityQuestionPreview
                                        AdaptivityQuestion="question">
                                    </AdaptivityQuestionPreview>
                                </TooltipContent>
                            </MudTooltip>
                        </div>
                    <div class="flex flex-col">
                        <div class="flex justify-center items-center">
                             <MudButton Class="btn-standard px-2 w-40 2xl:w-48 relative" OnClick="() => AddOrEditQuestion(context, difficulty)">
                             <MudText Class="flex justify-center items-center uppercase font-bold text-xs 2xl:text-sm">@Localizer["AdaptivityContentDialog.Table.Button.Question." + difficulty]</MudText>
                                      <div class="flex justify-end absolute w-2.5 h-1.5 -top-4 -right-3 m-0.5">
                                          <MudIconButton Class="w-2 h-2 shadow-none close-button rounded-full btn-standard" Size="Size.Small" Icon="@Icons.Material.Filled.Delete" OnClick="() => RemoveQuestion(context, difficulty)"></MudIconButton>
                                      </div>
                             </MudButton>
                        </div>
                       <MudDivider></MudDivider>
                        <div class="flex justify-center items-center">
                            <AdaptivityContentDialogRuleControl Question="question"/>
                        </div>
                    </div>

                        <div>
                            <MudTooltip Placement="Placement.Top" Duration="Double.Epsilon">
                                <ChildContent>
                                    <MudToggleIconButton Toggled="@context.MinimumRequiredDifficulty.Equals(difficulty)"
                                                         ToggledChanged="b => ChangeRequiredDifficulty(context, difficulty, b)"
                                                         ToggledIcon="@Icons.Material.Filled.Key" Icon="@Icons.Material.Outlined.KeyOff"/>
                                </ChildContent>
                                
                                <TooltipContent>
                                    Als "zu l√∂sende Frage" festlegen
                                </TooltipContent>
                            </MudTooltip>
                        </div>
                    </div>
                }
                else
                {
                    <div class="flex justify-center items-center">
                        <MudButton Variant="Variant.Filled" Class="btn-standard w-40 2xl:w-48" OnClick="() => AddOrEditQuestion(context, difficulty)">
                            <MudText Class="flex justify-center items-center text-xs 2xl:text-sm font-bold uppercase">@Localizer["AdaptivityContentDialog.Table.Button.Question." + difficulty]</MudText>
                        </MudButton>
                    </div>
                }
                
            </MudTd>
        }

    </RowTemplate>
    <FooterContent>
        <MudTFootRow>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Tasks"]">
                <span class="inline-flex">
                    <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="AddNewTask"/>
                </span>
            </MudTd>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.RequiredTask"]"/>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Easy"]"/>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Medium"]"/>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Hard"]"/>
        </MudTFootRow>
    </FooterContent>
</MudTable>

@code {

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types
    internal IDialogService DialogService { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types
    internal IPresentationLogic PresentationLogic { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types
    internal IStringLocalizer<AdaptivityContentDialog> Localizer { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types
    internal IMapper Mapper { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types
    internal IFormDataContainer<AdaptivityContentFormModel, AdaptivityContent> FormDataContainer { get; set; }

    [Parameter, EditorRequired]
    public IAdaptivityContentViewModel MyContent { get; set; } = null!;


    private MudTable<IAdaptivityTaskViewModel>? _table;


    private readonly Dictionary<IAdaptivityTaskViewModel, MudForm> _nameMudFormRefs = new();

    private readonly Dictionary<IAdaptivityTaskViewModel, string> _nameValues = new();

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        await MapIntoContainer();
        foreach (var task in MyContent.Tasks)
        {
            _nameValues.Add(task, task.Name);
            _nameMudFormRefs.Add(task, null!);
        }
    }

    private async Task MapIntoContainer()
    {
        Mapper.Map(MyContent, FormDataContainer.FormModel);
        await InvokeAsync(StateHasChanged);
    }

    private async void AddNewTask()
    {
        PresentationLogic.CreateAdaptivityTask(MyContent, Localizer["AdaptivityContentDialog.NewTask.Name", MyContent.Tasks.Count + 1]);
        var lastTask = MyContent.Tasks.Last();
        _nameValues.Add(lastTask, lastTask.Name);
        _nameMudFormRefs.Add(lastTask, null!);
        await MapIntoContainer();
    }

    private async Task RenameTask(IAdaptivityTaskViewModel task, string text)
    {
        await _nameMudFormRefs[task].Validate();
        if (!_nameMudFormRefs[task].IsValid) return;
        PresentationLogic.EditAdaptivityTask(task, text, task.MinimumRequiredDifficulty);
    }

    private void ChangeRequiredDifficulty(IAdaptivityTaskViewModel task, QuestionDifficulty difficulty, bool setChecked)
    {
        PresentationLogic.EditAdaptivityTask(task, task.Name, setChecked ? difficulty : null);
    }

    private void RemoveTask(IAdaptivityTaskViewModel task)
    {
        PresentationLogic.DeleteAdaptivityTask(MyContent, task);
        _nameValues.Remove(task);
        _nameMudFormRefs.Remove(task);
    }

    private async Task AddOrEditQuestion(IAdaptivityTaskViewModel task, QuestionDifficulty difficulty)
    {
        var options = new DialogOptions
        {
            DisableBackdropClick = false,
            MaxWidth = MaxWidth.Medium,
            FullWidth = false,
        };
        var dialog = await DialogService.ShowAsync<AdaptivityQuestionDialog>("", new DialogParameters()
        {
            {nameof(AdaptivityQuestionDialog.Task), task},
            {nameof(AdaptivityQuestionDialog.Difficulty), difficulty}
        }, options);
        var result = await dialog.Result;
        await InvokeAsync(StateHasChanged);
    }

    private void RemoveQuestion(IAdaptivityTaskViewModel task, QuestionDifficulty difficulty)
    {
        if (task.Questions.FirstOrDefault(x => x.Difficulty == difficulty) is {} question)
        {
            PresentationLogic.DeleteAdaptivityQuestion(task, question);
        }
    }

    private static IAdaptivityQuestionViewModel? GetTaskQuestionWithQuestionDifficulty(IAdaptivityTaskViewModel context, QuestionDifficulty questionDifficulty)
    {
        return context.Questions.FirstOrDefault(x => x.Difficulty == questionDifficulty);
    }

}