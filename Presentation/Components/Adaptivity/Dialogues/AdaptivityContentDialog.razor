@using Presentation.PresentationLogic.API
@using Presentation.PresentationLogic.LearningContent.AdaptivityContent
@using Shared.Adaptivity
@using Microsoft.Extensions.Localization
@using System.Diagnostics.CodeAnalysis
<MudTable @ref="@_table" Items="@MyContent.Tasks" Height="500px" Outlined="true" Style="border: 2px solid black; margin: 5px;"
          FixedHeader="true"
          FixedFooter="false" CustomFooter="true"
          Bordered="true">
    <HeaderContent>
        <MudTh>@Localizer["AdaptivityContentDialog.Table.Header.Tasks"]</MudTh>
        <MudTh>@Localizer["AdaptivityContentDialog.Table.Header.RequiredTask"]</MudTh>
        <MudTh>@Localizer["AdaptivityContentDialog.Table.Header.Easy"]</MudTh>
        <MudTh>@Localizer["AdaptivityContentDialog.Table.Header.Medium"]</MudTh>
        <MudTh>@Localizer["AdaptivityContentDialog.Table.Header.Hard"]</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Tasks"]">
            <span class="inline-flex">
                <MudTextField DebounceInterval="300" OnDebounceIntervalElapsed="(t) => RenameTask(context, t)" Value="@context.Name"/>
                <MudIconButton Icon="@Icons.Material.Filled.Remove" OnClick="() => RemoveTask(context)"/>
            </span>
        </MudTd>
        <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.RequiredTask"]">
            <MudCheckBox T="bool?" Checked="@(context.MinimumRequiredDifficulty != null)" Disabled="true"/>
        </MudTd>
        <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Easy"]">
            @if (HasTaskQuestionWithQuestionDifficulty(context, QuestionDifficulty.Easy))
            {
                <MudToggleIconButton Toggled="@context.MinimumRequiredDifficulty.Equals(QuestionDifficulty.Easy)"
                                     ToggledChanged="b => ChangeRequiredDifficulty(context, QuestionDifficulty.Easy, b)"
                                     ToggledIcon="@Icons.Material.Filled.Key" Icon="@Icons.Material.Outlined.KeyOff"/>
            }
            @if (HasTaskQuestionWithQuestionDifficulty(context, QuestionDifficulty.Easy))
            {
                <MudText>@context.Questions.First(x => x.Difficulty == QuestionDifficulty.Easy).ToString()</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => AddOrEditQuestion(context, QuestionDifficulty.Easy)"/>
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => RemoveQuestion(context, QuestionDifficulty.Easy)"/>
            }
            else
            {
                <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="() => AddOrEditQuestion(context, QuestionDifficulty.Easy)"/>
            }
        </MudTd>
        <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Medium"]">
            @if (HasTaskQuestionWithQuestionDifficulty(context, QuestionDifficulty.Medium))
            {
                <MudToggleIconButton Toggled="@context.MinimumRequiredDifficulty.Equals(QuestionDifficulty.Medium)"
                                     ToggledChanged="b => ChangeRequiredDifficulty(context, QuestionDifficulty.Medium, b)"
                                     ToggledIcon="@Icons.Material.Filled.Key" Icon="@Icons.Material.Outlined.KeyOff"/>
            }
            @if (HasTaskQuestionWithQuestionDifficulty(context, QuestionDifficulty.Medium))
            {
                <MudText>@context.Questions.First(x => x.Difficulty == QuestionDifficulty.Medium).ToString()</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => AddOrEditQuestion(context, QuestionDifficulty.Medium)"/>
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => RemoveQuestion(context, QuestionDifficulty.Medium)"/>
            }
            else
            {
                <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="() => AddOrEditQuestion(context, QuestionDifficulty.Medium)"/>
            }
        </MudTd>
        <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Hard"]">
            @if (HasTaskQuestionWithQuestionDifficulty(context, QuestionDifficulty.Hard))
            {
                <MudToggleIconButton Toggled="@context.MinimumRequiredDifficulty.Equals(QuestionDifficulty.Hard)"
                                     ToggledChanged="b => ChangeRequiredDifficulty(context, QuestionDifficulty.Hard, b)"
                                     ToggledIcon="@Icons.Material.Filled.Key" Icon="@Icons.Material.Outlined.KeyOff"/>
            }
            @if (HasTaskQuestionWithQuestionDifficulty(context, QuestionDifficulty.Hard))
            {
                <MudText>@context.Questions.First(x => x.Difficulty == QuestionDifficulty.Hard).ToString()</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => AddOrEditQuestion(context, QuestionDifficulty.Hard)"/>
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => RemoveQuestion(context, QuestionDifficulty.Hard)"/>
            }
            else
            {
                <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="() => AddOrEditQuestion(context, QuestionDifficulty.Hard)"/>
            }
        </MudTd>
    </RowTemplate>
    <FooterContent>
        <MudTFootRow>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Tasks"]">
                <span class="inline-flex">
                    <MudTextField T="string" @bind-Value="@_newTaskName"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="AddNewTask"/>
                </span>
            </MudTd>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.RequiredTask"]"/>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Easy"]"/>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Medium"]"/>
            <MudTd DataLabel="@Localizer["AdaptivityContentDialog.Table.Header.Hard"]"/>
        </MudTFootRow>
    </FooterContent>
</MudTable>

@code {

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types
    internal IDialogService DialogService { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types
    internal IPresentationLogic PresentationLogic { get; set; }

    [Inject, AllowNull] //can never be null, DI will throw exception on unresolved types
    internal IStringLocalizer<AdaptivityContentDialog> Localizer { get; set; }

    [Parameter, EditorRequired]
    public IAdaptivityContentViewModel MyContent { get; set; } = null!;

    private string _newTaskName = "";

    private MudTable<IAdaptivityTaskViewModel>? _table;

    private void AddNewTask()
    {
    //MyContent.Tasks.Add(new AdaptivityTaskViewModel(new List<IAdaptivityQuestionViewModel>(), QuestionDifficulty.Medium, _newTaskName.Length > 0 ? _newTaskName : "New Task " + MyContent.Tasks.Count()));
        PresentationLogic.CreateAdaptivityTask(MyContent, _newTaskName.Length > 0 ? _newTaskName : "New Task " + (MyContent.Tasks.Count() + 1));
        _newTaskName = "";
    }

    private void RenameTask(IAdaptivityTaskViewModel task, string text)
    {
        PresentationLogic.EditAdaptivityTask(task, text, task.MinimumRequiredDifficulty);
    }

    private void ChangeRequiredDifficulty(IAdaptivityTaskViewModel task, QuestionDifficulty difficulty, bool setChecked)
    {
        PresentationLogic.EditAdaptivityTask(task, task.Name, setChecked ? difficulty : null);
    }

    private void RemoveTask(IAdaptivityTaskViewModel task)
    {
        PresentationLogic.DeleteAdaptivityTask(MyContent, task);
    }

    private async void AddOrEditQuestion(IAdaptivityTaskViewModel task, QuestionDifficulty difficulty)
    {
        var options = new DialogOptions
        {
            DisableBackdropClick = false,
            MaxWidth = MaxWidth.Medium,
            FullWidth = false,
        };
        var dialog = await DialogService.ShowAsync<AdaptivityQuestionDialog>("AdaptivityQuestionDialogTitle", new DialogParameters() {{"Task", task}, {"Difficulty", difficulty}}, options);
        var result = await dialog.Result;
        await InvokeAsync(StateHasChanged);
    }

    private void RemoveQuestion(IAdaptivityTaskViewModel task, QuestionDifficulty difficulty)
    {
        if (task.Questions.FirstOrDefault(x => x.Difficulty == difficulty) is {} question)
        {
            PresentationLogic.DeleteAdaptivityQuestion(task, question);
        }
    }

    private static bool HasTaskQuestionWithQuestionDifficulty(IAdaptivityTaskViewModel context, QuestionDifficulty questionDifficulty)
    {
        return context.Questions.FirstOrDefault(x => x.Difficulty == questionDifficulty) != null;
    }

}